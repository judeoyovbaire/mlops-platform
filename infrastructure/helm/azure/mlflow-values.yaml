# MLflow Helm Values - Azure AKS (community-charts/mlflow v1.8.1)
# Backend: Azure PostgreSQL Flexible Server, Artifacts: Azure Blob Storage
replicaCount: 1

# Use chart's default image which includes psycopg2 for PostgreSQL
image:
  repository: burakince/mlflow
  tag: "3.7.0"
  pullPolicy: IfNotPresent

# Service account with Workload Identity
serviceAccount:
  create: true
  name: mlflow
  annotations:
    azure.workload.identity/client-id: "${mlflow_identity_client_id}"

# Backend store - Azure PostgreSQL
backendStore:
  databaseMigration: true
  postgres:
    enabled: true
    host: "${postgresql_host}"
    port: 5432
    database: "mlflow"
    user: "mlflow"
  # Use existing K8s secret for database credentials
  existingDatabaseSecret:
    name: "mlflow-db-credentials"
    usernameKey: "username"
    passwordKey: "password"

# Artifact store - Azure Blob Storage
artifactRoot:
  azureBlob:
    enabled: true
    connectionString: ""
    container: "mlflow-artifacts"

# Environment variables (chart 1.8.1 expects object, not array)
extraEnvVars:
  AZURE_STORAGE_ACCOUNT: "${storage_account_name}"
  MLFLOW_ARTIFACT_UPLOAD_DOWNLOAD_TIMEOUT: "600"
  # SSL mode for Azure PostgreSQL - require encrypted connections
  PGSSLMODE: "require"

# MLflow 3.x security settings
extraArgs:
  host: "0.0.0.0"
  allowed-hosts: "*"
  workers: "1"

# Disable chart's gunicorn logging
log:
  enabled: false

# Service configuration
service:
  type: ClusterIP
  port: 5000

# Resource configuration
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Pod security
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1001
  fsGroupChangePolicy: "OnRootMismatch"

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  capabilities:
    drop:
      - ALL

# Probes
livenessProbe:
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Ingress configuration (NGINX)
ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
  hosts:
    - host: mlflow.local
      paths:
        - path: /
          pathType: Prefix