# MLflow Helm Chart Values for AWS EKS (chart version 1.8.1)
# Uses RDS PostgreSQL and S3 for artifacts

replicaCount: 1

# Use chart's default image (burakince/mlflow) which includes psycopg2 for PostgreSQL
# The official ghcr.io/mlflow/mlflow image does NOT include database drivers
image:
  repository: burakince/mlflow
  tag: "3.7.0"
  pullPolicy: IfNotPresent

serviceAccount:
  create: false
  name: "mlflow"

service:
  type: ClusterIP
  port: 5000

# Backend store - RDS PostgreSQL
backendStore:
  databaseMigration: true
  postgres:
    enabled: true
    host: "${db_host}"
    port: 5432
    database: "${db_name}"
    user: "mlflow"
  # Use existing K8s secret for database credentials
  existingDatabaseSecret:
    name: "mlflow-postgres"
    usernameKey: "username"
    passwordKey: "password"

# Artifact store - S3
artifactRoot:
  s3:
    enabled: true
    bucket: "${s3_bucket}"
    awsAccessKeyId: ""
    awsSecretAccessKey: ""

# Environment variables for AWS SDK (chart 1.8.1 expects object, not array)
extraEnvVars:
  AWS_DEFAULT_REGION: "${aws_region}"

# MLflow 3.x security: allow connections from kubelet for health checks
# Setting log.enabled=false prevents chart from adding --gunicorn-opts,
# which allows uvicorn (default) to be used with security middleware flags
extraArgs:
  host: "0.0.0.0"
  allowed-hosts: "*"
  workers: "1"

# Disable chart's gunicorn logging (uses --gunicorn-opts which breaks security middleware)
# MLflow 3.x uses uvicorn by default which supports --allowed-hosts
log:
  enabled: false

# Resource configuration
resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Pod security (match chart defaults: user 1001)
podSecurityContext:
  runAsNonRoot: true
  fsGroup: 1001
  fsGroupChangePolicy: "OnRootMismatch"

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  capabilities:
    drop:
      - ALL

# Probes (chart handles httpGet internally, just set timing)
livenessProbe:
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# ALB Ingress (chart 1.8.1 requires host field)
ingress:
  enabled: true
  className: "alb"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
  hosts:
    - host: mlflow.local
      paths:
        - path: /
          pathType: Prefix