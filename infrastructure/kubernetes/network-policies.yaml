# Network Policies for MLOps Platform
# Implements namespace isolation and controlled traffic flow

---
# Default deny all ingress traffic in mlops namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: mlops
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# Allow ingress to inference services from istio-system (ingress gateway)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-inference-ingress
  namespace: mlops
spec:
  podSelector:
    matchLabels:
      serving.kserve.io/inferenceservice: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: istio-system
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8012

---
# Allow inference services to communicate with each other (for pipelines)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-inference-internal
  namespace: mlops
spec:
  podSelector:
    matchLabels:
      serving.kserve.io/inferenceservice: "true"
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: mlops
      ports:
        - protocol: TCP
          port: 8080

---
# MLflow namespace policies
---
# Default deny all ingress in mlflow namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: mlflow
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# Allow MLflow access from external (NodePort for local development)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mlflow-external
  namespace: mlflow
spec:
  podSelector:
    matchLabels:
      app: mlflow
  policyTypes:
    - Ingress
  ingress:
    # Allow from any source (needed for NodePort access in local dev)
    - ports:
        - protocol: TCP
          port: 5000

---
# Allow MLflow access from mlops and argo namespaces (training jobs)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mlflow-from-mlops
  namespace: mlflow
spec:
  podSelector:
    matchLabels:
      app: mlflow
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: mlops
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: argo
      ports:
        - protocol: TCP
          port: 5000

---
# Allow MLflow access from kserve namespace (model loading)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mlflow-from-kserve
  namespace: mlflow
spec:
  podSelector:
    matchLabels:
      app: mlflow
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kserve
      ports:
        - protocol: TCP
          port: 5000

---
# Allow MLflow to connect to PostgreSQL (egress)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mlflow-db-egress
  namespace: mlflow
spec:
  podSelector:
    matchLabels:
      app: mlflow
  policyTypes:
    - Egress
  egress:
    # PostgreSQL
    - to: []
      ports:
        - protocol: TCP
          port: 5432
    # S3 (HTTPS)
    - to: []
      ports:
        - protocol: TCP
          port: 443
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53

---
# Argo Workflows namespace policies
---
# Default deny ingress in argo namespace
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: argo
spec:
  podSelector: {}
  policyTypes:
    - Ingress

---
# Allow Argo Workflows UI access from ALB
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-argo-ui
  namespace: argo
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: argo-workflows-server
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: TCP
          port: 2746

---
# Allow Argo Workflows components to communicate internally
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-argo-internal
  namespace: argo
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: argo

---
# Allow Argo Workflows to access MLflow for experiment tracking
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-argo-mlflow-egress
  namespace: argo
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    # MLflow
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: mlflow
      ports:
        - protocol: TCP
          port: 5000
    # KServe for model deployment
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kserve
    # MinIO (internal)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: argo
      ports:
        - protocol: TCP
          port: 9000
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
    # HTTPS (for external data sources)
    - to: []
      ports:
        - protocol: TCP
          port: 443

---
# KServe namespace policies
---
# Allow KServe controller webhook and management traffic
# Note: We allow all ingress to kserve namespace because:
# 1. Webhook server needs to receive admission requests from API server
# 2. Controller needs to be accessible for health checks
# In production, this can be tightened based on specific requirements
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-kserve-controller
  namespace: kserve
spec:
  podSelector:
    matchLabels:
      control-plane: kserve-controller-manager
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow webhook calls from any namespace (API server proxies these)
    - ports:
        - protocol: TCP
          port: 9443
        - protocol: TCP
          port: 8443
        - protocol: TCP
          port: 8081
  egress:
    # Kubernetes API
    - to: []
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 6443
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
    # Access to mlops namespace for managing inference services
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: mlops