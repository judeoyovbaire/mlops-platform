# Multi-cloud CI/CD pipeline for AWS EKS, Azure AKS, and GCP GKE
# - Push/PR: Validates code and shows terraform plan
# - Manual: Deploy infrastructure or models to selected cloud

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly E2E tests on Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Cloud provider'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - azure
          - gcp
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'validate-only'
        type: choice
        options:
          - validate-only
          - deploy-infra
          - deploy-model

env:
  PYTHON_VERSION: "3.12"
  TERRAFORM_VERSION: "1.14.5"
  AWS_REGION: "eu-west-1"
  AZURE_LOCATION: "westeurope"
  GCP_REGION: "europe-west4"
  GCP_ZONE: "europe-west4-a"

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Stage 1: Validate (runs on every push/PR - no credentials needed)
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            pip-lint-${{ runner.os }}-

      - name: Install Ruff and Bandit
        run: pip install ruff bandit

      - name: Run Ruff linter
        run: ruff check pipelines/ examples/ --output-format=github

      - name: Run Ruff formatter check
        run: ruff format --check pipelines/ examples/

      - name: Run Bandit security scan
        run: bandit -r pipelines/ examples/ -f json -o bandit-results.json --exit-zero

      - name: Upload Bandit results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bandit-security-report
          path: bandit-results.json

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infrastructure/terraform/

      # AWS Validation
      - name: Validate EKS Module
        working-directory: infrastructure/terraform/modules/eks
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate AWS Bootstrap
        working-directory: infrastructure/terraform/bootstrap/aws
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate AWS Dev Environment
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate AWS Prod Environment
        working-directory: infrastructure/terraform/environments/aws/prod
        run: |
          terraform init -backend=false
          terraform validate

      # Azure Validation
      - name: Validate AKS Module
        working-directory: infrastructure/terraform/modules/aks
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Azure Bootstrap
        working-directory: infrastructure/terraform/bootstrap/azure
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Azure Dev Environment
        working-directory: infrastructure/terraform/environments/azure/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Azure Prod Environment
        working-directory: infrastructure/terraform/environments/azure/prod
        run: |
          terraform init -backend=false
          terraform validate

      # GCP Validation
      - name: Validate GKE Module
        working-directory: infrastructure/terraform/modules/gke
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate GCP Bootstrap
        working-directory: infrastructure/terraform/bootstrap/gcp
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate GCP Dev Environment
        working-directory: infrastructure/terraform/environments/gcp/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate GCP Prod Environment
        working-directory: infrastructure/terraform/environments/gcp/prod
        run: |
          terraform init -backend=false
          terraform validate

  validate-kubernetes:
    name: Validate Kubernetes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup kubeconform
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          kubeconform: "0.6.7"
          kustomize: "5.5.0"

      - name: Validate Kubernetes manifests
        run: |
          find components infrastructure/kubernetes -name '*.yaml' -o -name '*.yml' | \
            xargs -I {} kubeconform -strict -summary \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
              {} || true

      - name: Validate Kustomize build
        run: kustomize build infrastructure/kubernetes/ > /dev/null

  validate-helm:
    name: Validate Helm
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate AWS Helm values
        run: |
          for f in infrastructure/helm/aws/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
            yamllint -d relaxed "$f"
          done

      - name: Validate Azure Helm values
        run: |
          for f in infrastructure/helm/azure/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
            yamllint -d relaxed "$f"
          done

      - name: Validate GCP Helm values
        run: |
          for f in infrastructure/helm/gcp/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
            yamllint -d relaxed "$f"
          done

      - name: Validate Common Helm values
        run: |
          for f in infrastructure/helm/common/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
            yamllint -d relaxed "$f"
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner (IaC)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          trivyignores: '.trivyignore'
          skip-dirs: '**/.terraform'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Scan Dockerfiles with Trivy
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'config'
          scan-ref: 'components/'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          skip-dirs: '**/.terraform'


  test-python:
    name: Test Python
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-test-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            pip-test-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: pytest tests/ -v --tb=short --cov=pipelines --cov-report=xml --cov-report=term-missing --cov-fail-under=70 -n auto

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: coverage.xml

      - name: Audit Python dependencies
        run: |
          pip install pip-audit
          pip-audit --requirement <(pip freeze) --ignore-vuln PYSEC-0 || true

      - name: Validate Argo Workflow YAML
        run: |
          python3 -c "import yaml; list(yaml.safe_load_all(open('pipelines/training/ml-training-workflow.yaml')))"
          echo "Argo Workflow YAML is valid"

  # Stage 2: Terraform Plan (requires cloud credentials)
  terraform-plan-aws:
    name: Terraform Plan (AWS)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-python, validate-terraform, validate-kubernetes, validate-helm, security-scan, test-python]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        continue-on-error: true
        id: aws-creds

      - name: Setup Terraform
        if: steps.aws-creds.outcome == 'success'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        if: steps.aws-creds.outcome == 'success'
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: steps.aws-creds.outcome == 'success'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Get AWS Account ID
        if: steps.aws-creds.outcome == 'success'
        id: aws-account
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Terraform Init
        if: steps.aws-creds.outcome == 'success'
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          terraform init \
            -backend-config="bucket=mlops-platform-tfstate-${{ steps.aws-account.outputs.account_id }}" \
            -backend-config="key=mlops-platform/dev/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=mlops-platform-terraform-locks" \
            -backend-config="encrypt=true"

      - name: Check if EKS cluster exists
        if: steps.aws-creds.outcome == 'success'
        id: eks-check
        run: |
          if aws eks describe-cluster --name mlops-platform-dev --region ${{ env.AWS_REGION }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        if: steps.aws-creds.outcome == 'success'
        id: plan
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          # If EKS cluster doesn't exist, only plan the EKS module to avoid K8s provider errors
          if [ "${{ steps.eks-check.outputs.exists }}" == "false" ]; then
            echo "EKS cluster not found - planning infrastructure only (module.eks)"
            terraform plan -no-color -target=module.eks -out=tfplan 2>&1 | tee plan.txt
          else
            terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt
          fi

          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## AWS Terraform Plan: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## AWS Terraform Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.eks-check.outputs.exists }}" == "false" ]; then
              echo "> **Note:** EKS cluster doesn't exist yet. Showing plan for infrastructure only." >> $GITHUB_STEP_SUMMARY
              echo "> After deploying, run again to see full plan including Kubernetes resources." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "<details><summary>Click to expand plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -500 plan.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment Plan on PR
        if: steps.aws-creds.outcome == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/terraform/environments/aws/dev/plan.txt', 'utf8');
            const maxLength = 65000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n... (truncated)'
              : plan;

            const output = `## AWS Terraform Plan

            <details><summary>Show Plan</summary>

            \`\`\`
            ${truncatedPlan}
            \`\`\`

            </details>

            **To deploy**: After merging, go to Actions → CI/CD → Run workflow → Select "aws" and "deploy-infra"

            *Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Skip notice (no AWS credentials)
        if: steps.aws-creds.outcome != 'success'
        run: |
          echo "## AWS Terraform Plan: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AWS credentials not configured. Add \`AWS_ROLE_ARN\` secret after running bootstrap." >> $GITHUB_STEP_SUMMARY

  # Terraform Plan - Azure
  terraform-plan-azure:
    name: Terraform Plan (Azure)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-python, validate-terraform, validate-kubernetes, validate-helm, security-scan, test-python]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: azure-creds

      - name: Setup Terraform
        if: steps.azure-creds.outcome == 'success'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        if: steps.azure-creds.outcome == 'success'
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: steps.azure-creds.outcome == 'success'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        if: steps.azure-creds.outcome == 'success'
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Check if AKS cluster exists
        if: steps.azure-creds.outcome == 'success'
        id: aks-check
        run: |
          if az aks show --resource-group mlops-platform-dev-rg --name mlops-platform-dev &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        if: steps.azure-creds.outcome == 'success'
        id: plan
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          # If AKS cluster doesn't exist, only plan the AKS module to avoid K8s provider errors
          if [ "${{ steps.aks-check.outputs.exists }}" == "false" ]; then
            echo "AKS cluster not found - planning infrastructure only (module.aks)"
            terraform plan -no-color -target=module.aks -out=tfplan 2>&1 | tee plan.txt
          else
            terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt
          fi

          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## Azure Terraform Plan: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## Azure Terraform Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.aks-check.outputs.exists }}" == "false" ]; then
              echo "> **Note:** AKS cluster doesn't exist yet. Showing plan for infrastructure only." >> $GITHUB_STEP_SUMMARY
              echo "> After deploying, run again to see full plan including Kubernetes resources." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "<details><summary>Click to expand plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -500 plan.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip notice (no Azure credentials)
        if: steps.azure-creds.outcome != 'success'
        run: |
          echo "## Azure Terraform Plan: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Azure credentials not configured. Add \`AZURE_CLIENT_ID\`, \`AZURE_TENANT_ID\`, and \`AZURE_SUBSCRIPTION_ID\` secrets after running bootstrap." >> $GITHUB_STEP_SUMMARY

  # Terraform Plan - GCP
  terraform-plan-gcp:
    name: Terraform Plan (GCP)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-python, validate-terraform, validate-kubernetes, validate-helm, security-scan, test-python]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        continue-on-error: true
        id: gcp-creds

      - name: Setup Terraform
        if: steps.gcp-creds.outcome == 'success'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        if: steps.gcp-creds.outcome == 'success'
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: steps.gcp-creds.outcome == 'success'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Set up Cloud SDK
        if: steps.gcp-creds.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v3

      - name: Terraform Init
        if: steps.gcp-creds.outcome == 'success'
        working-directory: infrastructure/terraform/environments/gcp/dev
        run: terraform init

      - name: Check if GKE cluster exists
        if: steps.gcp-creds.outcome == 'success'
        id: gke-check
        run: |
          if gcloud container clusters describe mlops-platform-dev --zone ${{ env.GCP_ZONE }} --project ${{ secrets.GCP_PROJECT_ID }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        if: steps.gcp-creds.outcome == 'success'
        id: plan
        working-directory: infrastructure/terraform/environments/gcp/dev
        run: |
          # If GKE cluster doesn't exist, only plan the GKE module to avoid K8s provider errors
          if [ "${{ steps.gke-check.outputs.exists }}" == "false" ]; then
            echo "GKE cluster not found - planning infrastructure only (module.gke)"
            terraform plan -no-color -target=module.gke -out=tfplan 2>&1 | tee plan.txt
          else
            terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt
          fi

          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## GCP Terraform Plan: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## GCP Terraform Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.gke-check.outputs.exists }}" == "false" ]; then
              echo "> **Note:** GKE cluster doesn't exist yet. Showing plan for infrastructure only." >> $GITHUB_STEP_SUMMARY
              echo "> After deploying, run again to see full plan including Kubernetes resources." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            echo "<details><summary>Click to expand plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -500 plan.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip notice (no GCP credentials)
        if: steps.gcp-creds.outcome != 'success'
        run: |
          echo "## GCP Terraform Plan: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "GCP credentials not configured. Add \`GCP_WORKLOAD_IDENTITY_PROVIDER\` and \`GCP_SERVICE_ACCOUNT\` secrets after running bootstrap." >> $GITHUB_STEP_SUMMARY

  # Deploy Infrastructure - AWS (manual trigger only)
  deploy-infra-aws:
    name: Deploy Infrastructure (AWS)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [terraform-plan-aws]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'aws' && github.event.inputs.action == 'deploy-infra'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Get AWS Account ID
        id: aws-account
        run: echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_OUTPUT

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}
        run: |
          terraform init \
            -backend-config="bucket=mlops-platform-tfstate-${{ steps.aws-account.outputs.account_id }}" \
            -backend-config="key=mlops-platform/${{ github.event.inputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="dynamodb_table=mlops-platform-terraform-locks" \
            -backend-config="encrypt=true"

      - name: Backup Terraform State
        working-directory: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}
        run: |
          terraform state pull > terraform.tfstate.backup
          echo "State backed up before apply"

      - name: Upload State Backup
        uses: actions/upload-artifact@v6
        with:
          name: terraform-state-backup-aws-${{ github.event.inputs.environment }}-${{ github.run_id }}
          path: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}/terraform.tfstate.backup
          retention-days: 30

      - name: Terraform Apply - Stage 1 (EKS Infrastructure)
        working-directory: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}
        run: |
          echo "Stage 1: Deploying EKS cluster and infrastructure..."
          terraform apply -auto-approve -target=module.eks

      - name: Terraform Apply - Stage 2 (Kubernetes Resources)
        working-directory: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}
        run: |
          echo "Stage 2: Deploying Helm releases and Kubernetes resources..."
          terraform apply -auto-approve

      - name: Get Outputs
        working-directory: infrastructure/terraform/environments/aws/${{ github.event.inputs.environment }}
        run: |
          echo "## AWS Infrastructure Deployed (${{ github.event.inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY

      - name: Configure kubectl
        run: aws eks update-kubeconfig --name mlops-platform-${{ github.event.inputs.environment }} --region ${{ env.AWS_REGION }}

      - name: Verify Cluster
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Cluster provisioning..."
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Deploy Infrastructure - Azure (manual trigger only)
  deploy-infra-azure:
    name: Deploy Infrastructure (Azure)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [terraform-plan-azure]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'azure' && github.event.inputs.action == 'deploy-infra'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/download/v0.2.10/kubelogin-linux-amd64.zip
          unzip kubelogin-linux-amd64.zip -d kubelogin
          sudo mv kubelogin/bin/linux_amd64/kubelogin /usr/local/bin/
          kubelogin --version
      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Backup Terraform State
        working-directory: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform state pull > terraform.tfstate.backup
          echo "State backed up before apply"

      - name: Upload State Backup
        uses: actions/upload-artifact@v6
        with:
          name: terraform-state-backup-azure-${{ github.event.inputs.environment }}-${{ github.run_id }}
          path: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}/terraform.tfstate.backup
          retention-days: 30

      - name: Terraform Apply - Stage 1 (AKS Infrastructure)
        working-directory: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "Stage 1: Deploying AKS cluster and infrastructure..."
          terraform apply -auto-approve -target=module.aks

      - name: Terraform Apply - Stage 2 (Kubernetes Resources)
        working-directory: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "Stage 2: Deploying Helm releases and Kubernetes resources..."
          terraform apply -auto-approve

      - name: Get Outputs
        working-directory: infrastructure/terraform/environments/azure/${{ github.event.inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "## Azure Infrastructure Deployed (${{ github.event.inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY

      - name: Configure kubectl
        run: |
          az aks get-credentials \
            --resource-group mlops-platform-${{ github.event.inputs.environment }}-rg \
            --name mlops-platform-${{ github.event.inputs.environment }} \
            --overwrite-existing
          kubelogin convert-kubeconfig -l azurecli

      - name: Verify Cluster
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Cluster provisioning..."
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Deploy Infrastructure - GCP (manual trigger only)
  deploy-infra-gcp:
    name: Deploy Infrastructure (GCP)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [terraform-plan-gcp]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'gcp' && github.event.inputs.action == 'deploy-infra'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Install gke-gcloud-auth-plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}
        run: terraform init

      - name: Backup Terraform State
        working-directory: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}
        run: |
          terraform state pull > terraform.tfstate.backup
          echo "State backed up before apply"

      - name: Upload State Backup
        uses: actions/upload-artifact@v6
        with:
          name: terraform-state-backup-gcp-${{ github.event.inputs.environment }}-${{ github.run_id }}
          path: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}/terraform.tfstate.backup
          retention-days: 30

      - name: Terraform Apply - Stage 1 (GKE Infrastructure)
        working-directory: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}
        run: |
          echo "Stage 1: Deploying GKE cluster and infrastructure..."
          terraform apply -auto-approve -target=module.gke

      - name: Terraform Apply - Stage 2 (Kubernetes Resources)
        working-directory: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}
        run: |
          echo "Stage 2: Deploying Helm releases and Kubernetes resources..."
          terraform apply -auto-approve

      - name: Get Outputs
        working-directory: infrastructure/terraform/environments/gcp/${{ github.event.inputs.environment }}
        run: |
          echo "## GCP Infrastructure Deployed (${{ github.event.inputs.environment }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials mlops-platform-${{ github.event.inputs.environment }} \
            --zone ${{ env.GCP_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Verify Cluster
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Cluster provisioning..."
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # Deploy Model - AWS (manual trigger only)
  deploy-model-aws:
    name: Deploy Model (AWS)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [terraform-plan-aws]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'aws' && github.event.inputs.action == 'deploy-model'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl
        run: aws eks update-kubeconfig --name mlops-platform-${{ github.event.inputs.environment }} --region ${{ env.AWS_REGION }}

  deploy-model-aws-kserve:
    needs: [deploy-model-aws]
    uses: ./.github/workflows/reusable-deploy-model.yaml
    with:
      cloud: AWS
      environment: ${{ github.event.inputs.environment }}

  # Deploy Model - Azure (manual trigger only)
  deploy-model-azure:
    name: Deploy Model (Azure)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [terraform-plan-azure]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'azure' && github.event.inputs.action == 'deploy-model'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/download/v0.2.10/kubelogin-linux-amd64.zip
          unzip kubelogin-linux-amd64.zip -d kubelogin
          sudo mv kubelogin/bin/linux_amd64/kubelogin /usr/local/bin/
          kubelogin --version

      - name: Configure kubectl
        run: |
          az aks get-credentials
            --resource-group mlops-platform-${{ github.event.inputs.environment }}-rg \
            --name mlops-platform-${{ github.event.inputs.environment }} \
            --overwrite-existing
          kubelogin convert-kubeconfig -l azurecli

  deploy-model-azure-kserve:
    needs: [deploy-model-azure]
    uses: ./.github/workflows/reusable-deploy-model.yaml
    with:
      cloud: Azure
      environment: ${{ github.event.inputs.environment }}

  # Deploy Model - GCP (manual trigger only)
  deploy-model-gcp:
    name: Deploy Model (GCP)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [terraform-plan-gcp]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'gcp' && github.event.inputs.action == 'deploy-model'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Install gke-gcloud-auth-plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials mlops-platform-${{ github.event.inputs.environment }} \
            --zone ${{ env.GCP_ZONE }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

  deploy-model-gcp-kserve:
    needs: [deploy-model-gcp]
    uses: ./.github/workflows/reusable-deploy-model.yaml
    with:
      cloud: GCP
      environment: ${{ github.event.inputs.environment }}

  # E2E Tests (nightly schedule, manual trigger, or PR label)
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test-python]
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'e2e-test'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
          curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install Argo CLI
        run: |
          curl -sLO --retry 3 --retry-delay 5 https://github.com/argoproj/argo-workflows/releases/download/v3.7.2/argo-linux-amd64.gz
          gunzip argo-linux-amd64.gz
          chmod +x argo-linux-amd64
          sudo mv argo-linux-amd64 /usr/local/bin/argo

      - name: Create Kind cluster
        run: |
          kind create cluster --config tests/e2e/kind-config.yaml --wait 120s

      - name: Install Argo Workflows
        run: |
          kubectl create namespace argo
          for i in 1 2 3; do
            kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.7.2/quick-start-minimal.yaml && break
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          kubectl wait --for=condition=available deployment/argo-server -n argo --timeout=120s

      - name: Install MinIO
        run: |
          kubectl apply -f tests/e2e/minio.yaml
          kubectl wait --for=condition=available deployment/minio -n argo --timeout=120s
          kubectl wait --for=condition=complete job/minio-init -n argo --timeout=60s || true

      - name: Run E2E tests
        env:
          E2E_CLUSTER_TEST: "true"
        run: |
          pytest tests/e2e/ -v --tb=short -m e2e

      - name: Cleanup
        if: always()
        run: kind delete cluster --name mlops-e2e-test

  # Pipeline Summary
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [terraform-plan-aws, terraform-plan-azure, terraform-plan-gcp]
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: Summary
        run: |
          echo "## CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Multi-Cloud Platform Ready**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy to Dev Environment" >> $GITHUB_STEP_SUMMARY
          echo "Actions → CI/CD → Run workflow → Select cloud + Environment: \`dev\` + Action: \`deploy-infra\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deploy to Prod Environment" >> $GITHUB_STEP_SUMMARY
          echo "Actions → CI/CD → Run workflow → Select cloud + Environment: \`prod\` + Action: \`deploy-infra\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Clouds" >> $GITHUB_STEP_SUMMARY
          echo "- \`aws\` - AWS EKS" >> $GITHUB_STEP_SUMMARY
          echo "- \`azure\` - Azure AKS" >> $GITHUB_STEP_SUMMARY
          echo "- \`gcp\` - GCP GKE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To destroy** (local only for safety):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "make destroy-aws    # Destroy AWS" >> $GITHUB_STEP_SUMMARY
          echo "make destroy-azure  # Destroy Azure" >> $GITHUB_STEP_SUMMARY
          echo "make destroy-gcp    # Destroy GCP" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
