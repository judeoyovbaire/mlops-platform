# Unified CI/CD Pipeline for MLOps Platform
#
# Multi-Cloud Support: AWS EKS and Azure AKS
#
# This pipeline handles all validation, planning, and deployment:
# - On push/PR: Validates code and shows terraform plan for both clouds
# - Manual dispatch: Deploy infrastructure or models to selected cloud
#
# Destroy is intentionally excluded - run locally via `make destroy-{aws,azure}` for safety

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      cloud:
        description: 'Cloud provider'
        required: true
        default: 'aws'
        type: choice
        options:
          - aws
          - azure
      action:
        description: 'Action to perform'
        required: true
        default: 'validate-only'
        type: choice
        options:
          - validate-only
          - deploy-infra
          - deploy-model

env:
  PYTHON_VERSION: "3.10"
  TERRAFORM_VERSION: "1.6.0"
  AWS_REGION: "eu-west-1"
  AZURE_LOCATION: "westeurope"

permissions:
  id-token: write
  contents: read
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ============================================================================
  # STAGE 1: VALIDATE
  # Runs on every push/PR - no cloud credentials needed
  # ============================================================================

  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-lint-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            pip-lint-${{ runner.os }}-

      - name: Install Ruff and Bandit
        run: pip install ruff bandit

      - name: Run Ruff linter
        run: ruff check pipelines/ examples/ --output-format=github

      - name: Run Ruff formatter check
        run: ruff format --check pipelines/ examples/

      - name: Run Bandit security scan
        run: bandit -r pipelines/ examples/ -f json -o bandit-results.json --exit-zero

      - name: Upload Bandit results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: bandit-security-report
          path: bandit-results.json

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infrastructure/terraform/

      # AWS Validation
      - name: Validate EKS Module
        working-directory: infrastructure/terraform/modules/eks
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate AWS Bootstrap
        working-directory: infrastructure/terraform/bootstrap/aws
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate AWS Dev Environment
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          terraform init -backend=false
          terraform validate

      # Azure Validation
      - name: Validate AKS Module
        working-directory: infrastructure/terraform/modules/aks
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Azure Bootstrap
        working-directory: infrastructure/terraform/bootstrap/azure
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Azure Dev Environment
        working-directory: infrastructure/terraform/environments/azure/dev
        run: |
          terraform init -backend=false
          terraform validate

  validate-kubernetes:
    name: Validate Kubernetes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubeconform
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          kubeconform: "0.6.7"
          kustomize: "5.5.0"

      - name: Validate Kubernetes manifests
        run: |
          find components infrastructure/kubernetes -name '*.yaml' -o -name '*.yml' | \
            xargs -I {} kubeconform -strict -summary \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
              {} || true

      - name: Validate Kustomize build
        run: kustomize build infrastructure/kubernetes/ > /dev/null

  validate-helm:
    name: Validate Helm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate AWS Helm values
        run: |
          for f in infrastructure/helm/aws/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
          done

      - name: Validate Azure Helm values
        run: |
          for f in infrastructure/helm/azure/*.yaml; do
            echo "Checking $f..."
            python3 -c "import yaml; yaml.safe_load(open('$f'))"
          done

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (IaC)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          trivyignores: '.trivyignore'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  test-python:
    name: Test Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-test-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            pip-test-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests with coverage
        run: pytest tests/ -v --tb=short --cov=pipelines --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report
          path: coverage.xml

      - name: Validate Argo Workflow YAML
        run: |
          python3 -c "import yaml; list(yaml.safe_load_all(open('pipelines/training/ml-training-workflow.yaml')))"
          echo "Argo Workflow YAML is valid"

  # ============================================================================
  # STAGE 2: TERRAFORM PLAN (AWS)
  # Runs on every push/PR - requires AWS credentials
  # ============================================================================

  terraform-plan-aws:
    name: Terraform Plan (AWS)
    runs-on: ubuntu-latest
    needs: [lint-python, validate-terraform, validate-kubernetes, validate-helm, security-scan, test-python]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        continue-on-error: true
        id: aws-creds

      - name: Setup Terraform
        if: steps.aws-creds.outcome == 'success'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        if: steps.aws-creds.outcome == 'success'
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: steps.aws-creds.outcome == 'success'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        if: steps.aws-creds.outcome == 'success'
        working-directory: infrastructure/terraform/environments/aws/dev
        run: terraform init

      - name: Terraform Plan
        if: steps.aws-creds.outcome == 'success'
        id: plan
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt

          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## AWS Terraform Plan: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## AWS Terraform Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Click to expand plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -500 plan.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment Plan on PR
        if: steps.aws-creds.outcome == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/terraform/environments/aws/dev/plan.txt', 'utf8');
            const maxLength = 65000;
            const truncatedPlan = plan.length > maxLength
              ? plan.substring(0, maxLength) + '\n\n... (truncated)'
              : plan;

            const output = `## AWS Terraform Plan

            <details><summary>Show Plan</summary>

            \`\`\`
            ${truncatedPlan}
            \`\`\`

            </details>

            **To deploy**: After merging, go to Actions → CI/CD → Run workflow → Select "aws" and "deploy-infra"

            *Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Skip notice (no AWS credentials)
        if: steps.aws-creds.outcome != 'success'
        run: |
          echo "## AWS Terraform Plan: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AWS credentials not configured. Add \`AWS_ROLE_ARN\` secret after running bootstrap." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 2: TERRAFORM PLAN (Azure)
  # Runs on every push/PR - requires Azure credentials
  # ============================================================================

  terraform-plan-azure:
    name: Terraform Plan (Azure)
    runs-on: ubuntu-latest
    needs: [lint-python, validate-terraform, validate-kubernetes, validate-helm, security-scan, test-python]
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true
        id: azure-creds

      - name: Setup Terraform
        if: steps.azure-creds.outcome == 'success'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        if: steps.azure-creds.outcome == 'success'
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        if: steps.azure-creds.outcome == 'success'
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        if: steps.azure-creds.outcome == 'success'
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Terraform Plan
        if: steps.azure-creds.outcome == 'success'
        id: plan
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt

          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "## Azure Terraform Plan: No Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date." >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "## Azure Terraform Plan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Click to expand plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -500 plan.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Skip notice (no Azure credentials)
        if: steps.azure-creds.outcome != 'success'
        run: |
          echo "## Azure Terraform Plan: Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Azure credentials not configured. Add \`AZURE_CLIENT_ID\`, \`AZURE_TENANT_ID\`, and \`AZURE_SUBSCRIPTION_ID\` secrets after running bootstrap." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 3: DEPLOY INFRASTRUCTURE - AWS (Manual Only)
  # Only runs when manually triggered with cloud = "aws" and action = "deploy-infra"
  # ============================================================================

  deploy-infra-aws:
    name: Deploy Infrastructure (AWS)
    runs-on: ubuntu-latest
    needs: [terraform-plan-aws]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'aws' && github.event.inputs.action == 'deploy-infra'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/aws/dev
        run: terraform init

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/aws/dev
        run: terraform apply -auto-approve

      - name: Get Outputs
        working-directory: infrastructure/terraform/environments/aws/dev
        run: |
          echo "## AWS Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY

      - name: Configure kubectl
        run: aws eks update-kubeconfig --name mlops-platform-dev --region ${{ env.AWS_REGION }}

      - name: Verify Cluster
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Cluster provisioning..."
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 3: DEPLOY INFRASTRUCTURE - Azure (Manual Only)
  # Only runs when manually triggered with cloud = "azure" and action = "deploy-infra"
  # ============================================================================

  deploy-infra-azure:
    name: Deploy Infrastructure (Azure)
    runs-on: ubuntu-latest
    needs: [terraform-plan-azure]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'azure' && github.event.inputs.action == 'deploy-infra'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
            infrastructure/terraform/**/.terraform
          key: terraform-${{ runner.os }}-${{ hashFiles('infrastructure/terraform/**/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Configure Terraform plugin cache
        run: |
          mkdir -p ~/.terraform.d/plugin-cache
          echo 'plugin_cache_dir = "$HOME/.terraform.d/plugin-cache"' > ~/.terraformrc

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform apply -auto-approve

      - name: Get Outputs
        working-directory: infrastructure/terraform/environments/azure/dev
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          echo "## Azure Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "| \(.key) | \(.value.value // "N/A") |"' >> $GITHUB_STEP_SUMMARY

      - name: Configure kubectl
        run: |
          az aks get-credentials \
            --resource-group rg-mlops-platform-dev \
            --name mlops-platform-dev \
            --overwrite-existing

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/download/v0.1.0/kubelogin-linux-amd64.zip
          unzip kubelogin-linux-amd64.zip -d kubelogin
          sudo mv kubelogin/bin/linux_amd64/kubelogin /usr/local/bin/
          kubelogin convert-kubeconfig -l azurecli

      - name: Verify Cluster
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Cluster Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Cluster provisioning..."
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 4: DEPLOY MODEL - AWS (Manual Only)
  # Only runs when manually triggered with cloud = "aws" and action = "deploy-model"
  # ============================================================================

  deploy-model-aws:
    name: Deploy Model (AWS)
    runs-on: ubuntu-latest
    needs: [terraform-plan-aws]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'aws' && github.event.inputs.action == 'deploy-model'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl
        run: aws eks update-kubeconfig --name mlops-platform-dev --region ${{ env.AWS_REGION }}

      - name: Deploy to KServe
        run: |
          kubectl apply -f components/kserve/inferenceservice-examples.yaml

          echo "## Model Deployment (AWS)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed KServe InferenceService examples" >> $GITHUB_STEP_SUMMARY

      - name: Wait for deployment
        run: |
          echo "Waiting for InferenceService to be ready..."
          kubectl wait --for=condition=Ready inferenceservice/sklearn-iris -n mlops --timeout=300s || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## InferenceService Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get inferenceservice -n mlops >> $GITHUB_STEP_SUMMARY 2>&1
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Get service URL
        run: |
          SERVICE_URL=$(kubectl get inferenceservice sklearn-iris -n mlops -o jsonpath='{.status.url}' 2>/dev/null || echo "pending")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service URL" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${SERVICE_URL}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 4: DEPLOY MODEL - Azure (Manual Only)
  # Only runs when manually triggered with cloud = "azure" and action = "deploy-model"
  # ============================================================================

  deploy-model-azure:
    name: Deploy Model (Azure)
    runs-on: ubuntu-latest
    needs: [terraform-plan-azure]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.cloud == 'azure' && github.event.inputs.action == 'deploy-model'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure kubectl
        run: |
          az aks get-credentials \
            --resource-group rg-mlops-platform-dev \
            --name mlops-platform-dev \
            --overwrite-existing

      - name: Install kubelogin
        run: |
          curl -LO https://github.com/Azure/kubelogin/releases/download/v0.1.0/kubelogin-linux-amd64.zip
          unzip kubelogin-linux-amd64.zip -d kubelogin
          sudo mv kubelogin/bin/linux_amd64/kubelogin /usr/local/bin/
          kubelogin convert-kubeconfig -l azurecli

      - name: Deploy to KServe
        run: |
          kubectl apply -f components/kserve/inferenceservice-examples.yaml

          echo "## Model Deployment (Azure)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed KServe InferenceService examples" >> $GITHUB_STEP_SUMMARY

      - name: Wait for deployment
        run: |
          echo "Waiting for InferenceService to be ready..."
          kubectl wait --for=condition=Ready inferenceservice/sklearn-iris -n mlops --timeout=300s || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## InferenceService Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get inferenceservice -n mlops >> $GITHUB_STEP_SUMMARY 2>&1
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Get service URL
        run: |
          SERVICE_URL=$(kubectl get inferenceservice sklearn-iris -n mlops -o jsonpath='{.status.url}' 2>/dev/null || echo "pending")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Service URL" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${SERVICE_URL}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SUMMARY
  # Shows final status
  # ============================================================================

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [terraform-plan-aws, terraform-plan-azure]
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request')
    steps:
      - name: Summary
        run: |
          echo "## CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Multi-Cloud Platform Ready**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy to AWS:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Actions → CI/CD → Run workflow → Cloud: \`aws\` → Action: \`deploy-infra\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deploy to Azure:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Actions → CI/CD → Run workflow → Cloud: \`azure\` → Action: \`deploy-infra\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To destroy** (local only for safety):" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "make destroy-aws    # Destroy AWS" >> $GITHUB_STEP_SUMMARY
          echo "make destroy-azure  # Destroy Azure" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
